# For reference, here are the rules my newly-started container, macOS
# + Colima + Docker.  We are not flushing the existing ruleset because
# I don't want to lose these.
#
# table ip nat {
#     chain DOCKER_OUTPUT {
#         ip daddr 127.0.0.11 tcp dport 53 counter packets 0 bytes 0 dnat to 127.0.0.11:44109
#         ip daddr 127.0.0.11 udp dport 53 counter packets 0 bytes 0 dnat to 127.0.0.11:42753
#     }
#
#     chain OUTPUT {
#         type nat hook output priority dstnat; policy accept;
#         ip daddr 127.0.0.11 counter packets 0 bytes 0 jump DOCKER_OUTPUT
#     }
#
#     chain DOCKER_POSTROUTING {
#         ip saddr 127.0.0.11 tcp sport 44109 counter packets 0 bytes 0 snat to :53
#         ip saddr 127.0.0.11 udp sport 42753 counter packets 0 bytes 0 snat to :53
#     }
#
#     chain POSTROUTING {
#         type nat hook postrouting priority srcnat; policy accept;
#         ip daddr 127.0.0.11 counter packets 0 bytes 0 jump DOCKER_POSTROUTING
#     }
# }

destroy table llm_egress

table inet llm_egress {
    set allowed_ipv4 {
        typeof ip saddr
        flags interval
        elements = {
            # Cloudflare DNS
            1.1.1.1,
            # Quad9 DNS
            9.9.9.9,
            # Anthropic
            # https://docs.anthropic.com/en/api/ip-addresses
            160.79.104.0/23,
        }
    }

    set allowed_ipv6 {
        typeof ip6 saddr
        flags interval
        elements = {
            # Anthropic
            2607:6bc0::/48,
        }
    }

    chain output {
        type filter hook output priority filter
        policy drop

        ct state vmap {established: accept, related: accept, invalid: drop}
        oif lo accept
        ip daddr @allowed_ipv4 counter accept
        ip6 daddr @allowed_ipv6 counter accept
        # Faster failures
        meta l4proto {tcp, udp} counter reject
    }
}
